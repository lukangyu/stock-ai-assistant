name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SERVER_PORT || 22 }}
        script: |
          cd ${{ secrets.DEPLOY_PATH }}
          
          echo "Pulling latest changes..."
          git pull origin main
          
          echo "Stopping containers..."
          docker-compose down
          
          echo "Pulling latest images..."
          docker-compose pull
          
          echo "Starting containers..."
          docker-compose up -d
          
          echo "Cleaning up old images..."
          docker image prune -f
          
          echo "Checking container status..."
          docker-compose ps
          
          echo "Deployment completed!"

  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: Check AI Service Health
      run: |
        for i in {1..10}; do
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.SERVER_HOST }}:8000/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "AI Service is healthy!"
            exit 0
          fi
          echo "Attempt $i: AI Service not ready yet (HTTP $response)"
          sleep 10
        done
        echo "AI Service health check failed"
        exit 1
    
    - name: Check Java Backend Health
      run: |
        for i in {1..10}; do
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.SERVER_HOST }}:8080/api/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "Java Backend is healthy!"
            exit 0
          fi
          echo "Attempt $i: Java Backend not ready yet (HTTP $response)"
          sleep 10
        done
        echo "Java Backend health check failed"
        exit 1

  notify:
    runs-on: ubuntu-latest
    needs: [deploy, health-check]
    if: always()
    
    steps:
    - name: Send notification on success
      if: success()
      run: |
        echo "Deployment successful! :rocket:"
    
    - name: Send notification on failure
      if: failure()
      run: |
        echo "Deployment failed! :warning:"
